<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <link rel="stylesheet" href="style.css"/>
    <script src="https://cdn.jsdelivr.net/npm/vega@6.1.2"></script>
    <script src="https://cdn.jsdelivr.net/npm/vega-lite@6.2.0"></script>
    <script src="https://cdn.jsdelivr.net/npm/vega-embed@7.0.2"></script>
    <script src="data.js"></script>
    <script>
      const dropdownValues = data.map(n => n.food);
      // This part adapted from https://www.w3schools.com/howto/howto_js_autocomplete.asp

      function autocomplete(inp, arr) {
        /*the autocomplete function takes two arguments,
        the text field element and an array of possible autocompleted values:*/
        var currentFocus;
        /*execute a function when someone writes in the text field:*/
        inp.addEventListener("input", function(e) {
            var a, b, i, val = this.value;
            /*close any already open lists of autocompleted values*/
            closeAllLists();
            if (!val) { return false;}
            currentFocus = -1;
            /*create a DIV element that will contain the items (values):*/
            a = document.createElement("DIV");
            a.setAttribute("id", this.id + "autocomplete-list");
            a.setAttribute("class", "autocomplete-items");
            /*append the DIV element as a child of the autocomplete container:*/
            this.parentNode.appendChild(a);

            // Returns the count of the longest common sequence between two strings
            // Return Format: [start, end, count_longest_sequence]
            function CommonCharacters(s1, s2) {
                var maxCount = 0;
                var start = -1;

                for (var i = 0; i < s1.length - s2.length + 1; i++) {
                    var count = 0;

                    for (var j = i; j < s2.length + i; j++) {
                        if (s1[j].toUpperCase() !== s2[j - i].toUpperCase()) break;
                        count++;
                    }

                    if (count > maxCount) {
                        maxCount = count;
                        start = i;
                    }

                    if (count === s2.length) {
                        break;
                    }
                }

                return [start, start + maxCount, maxCount];
            }

            // Creates a copy of the list of all foods
            // Sort the list by length (Shortest first)
            // Filters out any words that don't have at least 1 common character to the input value
            // Sorts the list in order of foods with the longest sequence of common character to the input value
            sorted_values = dropdownValues.copyWithin()
                .sort((s1, s2) => s1.length - s2.length)
                .filter(s1 => CommonCharacters(s1, val)[2] > 0)
                .sort((s1, s2) => CommonCharacters(s2, val)[2] - CommonCharacters(s1, val)[2]);

            // Creates the html for each entry of the drop-down
            for (var i = 0; i < 15 && i < sorted_values.length; i++) {
                var b = document.createElement("div");
                var common = CommonCharacters(sorted_values[i], val);

                b.innerHTML = `${sorted_values[i].substring(0, common[0])}` +
                    `<strong>${sorted_values[i].substring(common[0], common[1])}</strong>` +
                    `${sorted_values[i].substring(common[1])}` +
                    `<input type="hidden" value="${sorted_values[i]}">`;

                b.addEventListener("click", function(_) {
                    /*insert the value for the autocomplete text field:*/
                    inp.value = this.getElementsByTagName("input")[0].value;
                    updateBars();
                    /*close the list of autocompleted values,
                    (or any other open lists of autocompleted values:*/
                    closeAllLists();
                });

                a.appendChild(b);
            }
        });
        /*execute a function presses a key on the keyboard:*/
        inp.addEventListener("keydown", function(e) {
            var x = document.getElementById(this.id + "autocomplete-list");
            if (x) x = x.getElementsByTagName("div");
            if (e.keyCode == 40) {
              /*If the arrow DOWN key is pressed,
              increase the currentFocus variable:*/
              currentFocus++;
              /*and and make the current item more visible:*/
              addActive(x);
            } else if (e.keyCode == 38) { //up
              /*If the arrow UP key is pressed,
              decrease the currentFocus variable:*/
              currentFocus--;
              /*and and make the current item more visible:*/
              addActive(x);
            } else if (e.keyCode == 13) {
              /*If the ENTER key is pressed, prevent the form from being submitted,*/
              e.preventDefault();
              if (currentFocus > -1) {
                /*and simulate a click on the "active" item:*/
                if (x) x[currentFocus].click();
              }
            }
        });
        function addActive(x) {
          /*a function to classify an item as "active":*/
          if (!x) return false;
          /*start by removing the "active" class on all items:*/
          removeActive(x);
          if (currentFocus >= x.length) currentFocus = 0;
          if (currentFocus < 0) currentFocus = (x.length - 1);
          /*add class "autocomplete-active":*/
          x[currentFocus].classList.add("autocomplete-active");
        }
        function removeActive(x) {
          /*a function to remove the "active" class from all autocomplete items:*/
          for (var i = 0; i < x.length; i++) {
            x[i].classList.remove("autocomplete-active");
          }
        }
        function closeAllLists(elmnt) {
          /*close all autocomplete lists in the document,
          except the one passed as an argument:*/
          var x = document.getElementsByClassName("autocomplete-items");
          for (var i = 0; i < x.length; i++) {
            if (elmnt != x[i] && elmnt != inp) {
              x[i].parentNode.removeChild(x[i]);
            }
          }
        }
        /*execute a function when someone clicks in the document:*/
        document.addEventListener("click", function (e) {
            closeAllLists(e.target);
        });
      }
    </script>
    <title>Nutrition Dashboard</title>
</head>
<body>
    <div>
        <div style="display:flex; gap:40px; align-items:flex-start;">


        <div id="vis"></div>

        <script type="text/javascript">

        var yourVlSpec = {
            "$schema": "https://vega.github.io/schema/vega-lite/v6.json",
            "data": { "url": "foodDataNoRaw.csv" },

            "params": [
            {
                "name": "highlighted",
                "value": [],
                "reactive": true
            }
            ],

            "hconcat": [
                {
                    "title": "Caloric Value vs. Protein Content in Non-Raw Foods",
                    "width": 700,
                    "height": 600,
                    "layer": [
                        {
                            "mark": "circle",
                            "encoding": {
                                "x": {
                                    "field": "Caloric Value",
                                    "type": "quantitative",
                                    "title": "Caloric Value (kcal/100g or 100mL)",
                                    "scale": {"type": "symlog", "domainMin": 0}
                                },
                                "y": {
                                    "field": "Protein",
                                    "type": "quantitative",
                                    "title": "Protein (grams/100g or 100mL)",
                                    "scale": {"type": "symlog", "domainMin": 0}
                                },

                                "color": {
                                    "condition": {
                                        "test": "indexof(highlighted, datum.food) >= 0",
                                        "value": "red"
                                    },
                                    "value": "royalblue"
                                },

                                "size": {
                                    "condition": {
                                        "test": {
                                            "field": "food",
                                            "oneOf": [
                                                "pork arm picnic cooked",
                                                "turkey breast roasted",
                                                "pork backfat",
                                                "banana cream pie",
                                                "pork backribs roasted",
                                                "coconut whole coconut",
                                                "pork centre rib roasts roasted",
                                                "pork top loin roasts roasted",
                                                "profeel proteiinirahka valio",
                                                "weetabix weetabix"
                                            ]
                                        },
                                        "value": 150
                                    },
                                    "value": 30
                                },

                                "tooltip": [
                                    {"field": "food", "type": "nominal", "title": "Food"},
                                    {"field": "Protein", "type": "quantitative", "title": "Protein (g)"},
                                    {"field": "Caloric Value", "type": "quantitative", "title": "Calories (kcal)"}
                                ]
                            }
                        },




                        {
                            "mark": {
                                "type": "line",
                                "color": "black",
                                "clip": true
                            },
                            "transform": [
                                {
                                    "regression": "Protein",
                                    "on": "Caloric Value",
                                    "extrapolate": true,
                                    "method": "linear",
                                    "extent": [0, 6500]
                                }
                            ],
                            "encoding": {
                                "x": {"field": "Caloric Value", "type": "quantitative"},
                                "y": {"field": "Protein", "type": "quantitative"}
                            }
                        }
                    ]



                }
            ]
        };

        let vegaView;

        vegaEmbed('#vis', yourVlSpec).then(res => {
            vegaView = res.view;
        });

        </script>



        <div class="tableContainer">
        <table class="straightTable">
        <caption>Top Ten Outlier Values and their Nutrition Data</caption>
        <tr>
            <th>Food Name</th>
            <th>Caloric Value</th>
            <th>Protein (g)</th>
            <th>Carbohydrates</th>
        </tr>

        <tr><td class="foodButton">pork arm picnic cooked</td><td>5292.0</td><td>560.3</td><td>0.0</td></tr>
        <tr><td class="foodButton">turkey breast roasted</td><td>3266.0</td><td>496.1</td><td>0.0</td></tr>
        <tr><td class="foodButton">pork backfat</td><td>3683.0</td><td>13.2</td><td>0.0</td></tr>
        <tr><td class="foodButton">banana cream pie</td><td>3190.0</td><td>52.2</td><td>390.2</td></tr>
        
        <tr><td class="foodButton">pork backribs roasted</td><td>2564.0</td><td>202.0</td><td>0.0</td></tr>
        <tr><td class="foodButton">coconut whole coconut</td><td>3336.0</td><td>0.0</td><td>0.0</td></tr>
        <tr><td class="foodButton">pork centre rib roasts roasted</td><td>1942.0</td><td>211.3</td><td>0.0</td></tr>
        <tr><td class="foodButton">pork top loin roasts roasted</td><td>1628.0</td><td>224.3</td><td>0.0</td></tr>
        <tr><td class="foodButton">profeel proteiinirahka valio</td><td>140.0</td><td>175.0</td><td>19.3</td></tr>
        <tr><td class="foodButton">weetabix weetabix</td><td>2078.0</td><td>0.0</td><td>0.0</td></tr>

        </table>
        </div>

        </div> 



        <script>
        document.querySelectorAll(".foodButton").forEach(cell => {

            cell.addEventListener("click", () => {
                if (!vegaView) return;

                const foodName = cell.textContent.trim();

                
                let active = vegaView.signal("highlighted").slice();

            
                if (active.includes(foodName)) {
                    active = active.filter(f => f !== foodName);
                    
                    cell.style.backgroundColor = "rgba(255,0,0,0.10)";
                } else {
                    active.push(foodName);
                    cell.style.backgroundColor = "lightgreen";
                }
                vegaView.signal("highlighted", active).run();
            });
        });
        </script>
    </div>

    <div>
        <h2 style="text-align: center; font-size: 22px;">Food Nutriention Table</h2>
        <div style="display: flex; justify-content: center;">
            <div class="autocomplete" style="font-size: 20px; text-align: center">
                <input type="search" id="searchBarV4" class="search-bar" placeholder="Enter Food" style="width: 500px;">
            </div>
        </div>
        
        <table id="TableV4" style="margin: 20px 16px;">
            <tr><th>Food</th><th>Count</th><th>Calories</th><th>Carbs(g)</th><th>Protein(g)</th><th>Fats(g)</th><th>Sugar(g)</th></tr>
        </table>

        <select id="food-selectV4" style="float: right; margin-right: 5px;width: 400px; height: 40px; font-size: 20px; border-radius: 12px; background-color: #eeeeee;"></select>
        <div style="width: 100%; display: flex; justify-content: center"><div id="vis2" style="margin-left: auto; margin-right: auto;"></div></div>

        <script src="index.js"></script>
        <script src="vega-lite.js"></script>
    </div>

    <div>
        <h2 style="text-align: center">Compare Foods</h2>
        
        <div style="display: flex; justify-content: center; gap: 50px">
            <div style="display: flex; justify-content: center;">
                <div class="autocomplete">
                    <div class="food_checkbox" style="display: flex;align-items: center;gap: 5px;"><input id="dropdownInput" class="search-bar" type="text" name="myDropdown", placeholder="Enter Food 1"></div>
                </div>
            </div>
            <div style="display: flex; justify-content: center;">
                <div class="autocomplete">
                    <div class="food_checkbox" style="display: flex;align-items: center;gap: 5px;"><input id="dropdownInput2" class="search-bar" type="text" name="myDropdown", placeholder="Enter Food 2"></div>
                </div>
            </div>
        </div>
        <br>
        <div style = "width: 50%; margin: 0 auto; display: block;">
            <div id="vis3"></div>
        </div>
        <br>

        <script type="text/javascript">
            var view;
            var mySpec = {
            "$schema": "https://vega.github.io/schema/vega-lite/v6.json",
            "width": 500,
            "height": 300,
            "data": {
                "url": "foodData.json"
            },
            "transform": [
                {"filter": "(datum.food == choice1 || datum.food == choice2) && ((datum.nutrient == 'Protein' && Protein) || (datum.nutrient == 'Fat' && Fat) || (datum.nutrient == 'Carbohydrates' && Carbs) || (datum.nutrient == 'Dietary Fiber' && Fiber) || (datum.nutrient == 'Sugars' && Sugar))"
                },
                {"filter": "datum.measurement == mode"},
                {"calculate": "datum.measurement == 'serving' ? datum.food + ' (' + datum.weight + 'g)' : datum.food + ' (100g)'", "as": "legend"}
                
            ],
            "params": [
                {
                    "name": "mode",
                    "value": "100g",
                    "bind": {
                        "input": "radio",
                        "options": ["100g", "serving"],
                        "name": "TOGGLE MASS: "
                    }
                },
                {"name": "choice1", "value": "cream cheese"},
                {"name": "choice2", "value": "ham egg cheese sandwich"},
                {"name": "Protein", "value": true, "bind": {"input": "checkbox", "label": "Protein"}},
                {"name": "Fat", "value": true, "bind": {"input": "checkbox", "label": "Fat"}},
                {"name": "Carbs", "value": true, "bind": {"input": "checkbox", "label": "Carbs"}},
                {"name": "Fiber", "value": false, "bind": {"input": "checkbox", "label": "Fiber"}},
                {"name": "Sugar", "value": false, "bind": {"input": "checkbox", "label": "Sugar"}},
            ],
            "layer": [ {
            "mark": "bar",
            "encoding": {
                "x": {"field": "nutrient", "type": "nominal", "axis": {"labelAngle": 0}},
                "y": {"field": "value", "type": "quantitative", "axis": {"title": "grams"}},
                "color": {"field": "legend", "type": "nominal", "title": "Food"},
                "xOffset": {"field": "food"}
            }},
            {
            "mark": {
                "type": "text",
                "dy": -5
            },
            "encoding": {
                "x": {"field": "nutrient", "type": "nominal"},
                "xOffset": {"field": "food"},
                "y": {"field": "value", "type": "quantitative"},
                "text": {"field": "value", "type": "quantitative"},
                "color": {"field": "legend", "type": "nominal"}
            }}]

            };
            vegaEmbed('#vis3', mySpec)
            .then(function (result) {
                view = result.view;
            })
            .catch(console.error);

            autocomplete(document.getElementById("dropdownInput"), dropdownValues);
            autocomplete(document.getElementById("dropdownInput2"), dropdownValues);

            function updateBars(){
            //console.log("Before: " + view.signal("dropdown"));
            view.signal("choice1", document.getElementById("dropdownInput").value);
            view.signal("choice2", document.getElementById("dropdownInput2").value);
            //console.log("After: " +view.signal("dropdown"));
            view.run();
            }

            document.getElementById("dropdownInput").addEventListener("keydown", (e) => {if (e.key === 'Enter' || e.keyCode === 13) {updateBars();}})
        </script>
    </div>
</body>
</html>