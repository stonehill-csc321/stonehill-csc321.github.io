<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pokemon Stat Comparison</title>
    <script src="https://cdn.jsdelivr.net/npm/vega@5"></script>
    <script src="https://cdn.jsdelivr.net/npm/vega-lite@5"></script>
    <script src="https://cdn.jsdelivr.net/npm/vega-embed@6"></script>

    
    <style>
        * {
            box-sizing: border-box;
        }
        
        body {
            margin: 0;
            padding: 80px 20px 20px 20px;
            font-family: Arial, sans-serif;
            background: linear-gradient(135deg, #3B4CCA 0%, #FF0000 100%);
        }
        
        .main-container {
            display: flex;
            max-width: 1200px;
            margin: 0 auto;
            gap: 20px;
            align-items: flex-start;
        }
        
        .pokemon-side {
            flex: 1;
            text-align: center;
        }
        
        .chart-container {
            flex: 2;
            background: white;
            padding: 20px;
            border: 1px solid #ccc;
            border-radius: 5px;
        }
        
        .pokemon-image {
            width: 150px;
            height: 150px;
            border: 3px solid;
            border-radius: 10px;
            margin: 0 auto 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: white;
        }
        
        #pokemon1 .pokemon-image {
            border-color: #2563eb;
        }
        
        #pokemon2 .pokemon-image {
            border-color: #dc2626;
        }
        
        .pokemon-image img {
            max-width: 120px;
            max-height: 120px;
            image-rendering: pixelated;
        }
        
        .pokemon-name {
            font-size: 18px;
            font-weight: bold;
            margin-bottom: 10px;
            color: #ffffff;
        }
        
        select {
            padding: 8px;
            font-size: 14px;
            border: 1px solid #ccc;
            border-radius: 3px;
            width: 100%;
            max-width: 200px;
        }

        .dropdown {
            position: absolute;
            top: 100%;              /* Appears below search box */
            left: 0;
            right: 0;
            background: white;
            border-radius: 0 0 20px 20px;
            margin-top: 5px;
            max-height: 400px;      /* Scroll if too many results */
            overflow-y: auto;
            box-shadow: 0 8px 32px rgba(0,0,0,0.2);
            display: none;          /* Hidden by default */
            z-index: 1000;
        }

        .dropdown.active {
            display: block;         /* Shown when results exist */
        }

        .search-input {
            width: 100%;
            padding: 12px 16px;
            font-size: 16px;
            border: 1px solid #ccc;
            border-radius: 8px;
            background-color: white;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            transition: all 0.3s ease;
        }

        .search-input:focus {
            outline: none;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            border-color: #2563eb;
        }

        .dropdown-item {
            padding: 12px 16px;
            cursor: pointer;
            border-bottom: 1px solid #f0f0f0;
            transition: background-color 0.2s ease;
            text-align: left;
            color: #333;
        }

        .dropdown-item:hover {
            background-color: #f5f5f5;
        }

        .search-container {
            position: relative;
            display: inline-block;
            width: 100%;
            max-width: 200px;
        }


        

        
        #visualization {
            margin-top: 20px;
        }
        
        h1 {
            text-align: center;
            color: #ffffff;
            margin-bottom: 30px;
        }
        
        .error {
            color: red;
            text-align: center;
            margin: 10px 0;
            display: none;
        }
        
        @media (max-width: 768px) {
            .main-container {
                flex-direction: column;
                align-items: center;
            }
            
            .pokemon-side {
                text-align: center;
            }
        }
    </style>

</head>

<body>

<nav style="position: fixed; top: 0; left: 0; right: 0; background: white; padding: 15px 20px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); z-index: 1000; width: 100%;">

        <a href="./index.html" style="margin-left: 20px;" >PokéSearch</a>
        <a href="./index.html#bubbleChart" style="margin-left: 20px;" >Generation PokéTypes</a>
        <a href="./final.html#pokemon-comparison" style="margin-left: 20px;">PokéCompare</a>
        <a href="./final.html" style="margin-left: 20px;">Average PokéStats</a>
        <a href="./final.html#pokemon-scatter" style="margin-left: 20px;">PokéScatter</a>
        

    </nav>

    <section id="Pokemon Stats by Type">
    <h1>Pokemon Stats by Type</h1>
        <div class="main-container">
            <div class="pokemon-side">
                <div class="pokemon-name">Select Attribute</div>
                <select id="select-stat-type">
                    <option value="">Choose Attribute</option>
                </select>
            </div>

            <div class="chart-container">
                <div id="visualization2"></div>
            </div>

        </div>
    </section>

    <section id="pokemon-scatter">
        <h1>Pokemon Scatter Plot</h1>
        <div class="chart-container">
            <div id="visualization3"></div>
        </div>
    </section>

    <section id="pokemon-comparison">
        <h1>Pokemon Stat Comparison</h1>
        
        <div class="main-container">
            <div class="pokemon-side" id="pokemon1">
                <div class="pokemon-name">Select First Pokemon</div>
                <div class="pokemon-image">
                    <img src="" alt="" style="display: none;">
                </div>
                <div class="search-container">
                <input 
                    type="text" 
                    class="search-input" 
                    id="select1" 
                    placeholder="Search Pokémon (type a letter or name)..."
                    autocomplete="off"
                >
                <div class="dropdown" id="dropdown1"></div>
            </div>
            </div>
            
            <div class="chart-container">
                <div class="error" id="error"></div>
                <div id="visualization"></div>
            </div>
            
            <div class="pokemon-side" id="pokemon2">
                <div class="pokemon-name">Select Second Pokemon</div>
                <div class="pokemon-image">
                    <img src="" alt="" style="display: none;">
                </div>
                <div class="search-container">
                <input 
                    type="text" 
                    class="search-input" 
                    id="select2" 
                    placeholder="Search Pokémon (type a letter or name)..."
                    autocomplete="off"
                >
                <div class="dropdown" id="dropdown2"></div>
            </div>
            </div>
        </div>
    </section>

    <script>
        let pokemonData = [];
        let currentPokemon1 = null;
        let currentPokemon2 = null;
        let typeStats = {};

        // Load CSV data
        fetch('intro.csv')
            .then(response => response.text())
            .then(csvText => {
                const lines = csvText.split('\n');
                const headers = lines[0].split(',');
                
                //iterate through lines to create pokemon objects
                for (let i = 1; i < lines.length; i++) {
                    if (lines[i].trim() === '') continue;
                    
                    const values = lines[i].split(',');
                    if (values.length < 10) continue;
                    
                    const pokemon = {
                        number: parseInt(values[0]),
                        name: values[1].trim(),
                        type1: values[2],
                        type2: values[3] || '',
                        hp: parseInt(values[4]),
                        attack: parseInt(values[5]),
                        defense: parseInt(values[6]),
                        spAttack: parseInt(values[7]),
                        spDefense: parseInt(values[8]),
                        speed: parseInt(values[9])
                    };
                    pokemonData.push(pokemon);
                }

                buildTypeStats();
                createTypeStatChart("hp");

                //populate dropdowns
                populateDropdown('select1');
                populateDropdown('select2');

                //set defaults to avoid null errors
                document.getElementById('select1').value = 'Pikachu';
                document.getElementById('select2').value = 'Charizard';
                document.getElementById('select-stat-type').innerHTML += 
                `
                    <option value="hp">HP</option>
                    <option value="attack">Attack</option>
                    <option value="defense">Defense</option>
                    <option value="speed">Speed</option>
                    <option value="spAttack">Sp.Attack</option>
                    <option value="spDefense">Sp.Defense</option>
                `;
                document.getElementById('select-stat-type').value = 'hp';

                updatePokemonDisplay('Pikachu', 1);
                updatePokemonDisplay('Charizard', 2);
                updateButton();
                // Render scatter chart on load
                createScatterChart();
            });
        
        function buildTypeStats() {
            typeStats = {};
            pokemonData.forEach(pokemon => {
                const type = pokemon.type1;
                if (!typeStats[type]) {
                    typeStats[type] = {
                        hp: 0, attack: 0, defense: 0, spAttack: 0, spDefense: 0, speed: 0,
                        count: 0
                    };
                }
                typeStats[type].hp += pokemon.hp;
                typeStats[type].attack += pokemon.attack;
                typeStats[type].defense += pokemon.defense;
                typeStats[type].spAttack += pokemon.spAttack;
                typeStats[type].spDefense += pokemon.spDefense;
                typeStats[type].speed += pokemon.speed;
                typeStats[type].count += 1;
            });
        }

        // Search and filter
        function updateDropdown(selection) {{
            const select = 'select'.concat(selection.slice(-1));
            const drpdwnval = 'dropdown'.concat(selection.slice(-1));

            const searchValue = document.getElementById(select).value.toLowerCase().trim();
            const dropdown = document.getElementById(drpdwnval);
            
            if (!searchValue) {{
                dropdown.classList.remove('active');
                return;
            }}
            
            const filtered = pokemonData.filter(pokemon => {{
                const name = pokemon.name ? pokemon.name.toLowerCase() : '';
                return name.includes(searchValue);
            }});
            
            dropdown.innerHTML = '';
            
            if (filtered.length === 0) {{
                dropdown.innerHTML = '<div class="dropdown-item" style="cursor: default; color: #999;">No results found</div>';
            }} else {{
                filtered.forEach(pokemon => {{
                    const item = document.createElement('div');
                    item.className = 'dropdown-item';
                    
                    // Create sprite icon if available
                    // if (pokemon.Sprite && pokemon.Sprite !== null && pokemon.Sprite !== '') {{
                    //     const img = document.createElement('img');
                    //     img.className = 'dropdown-item-icon';
                    //     // Use the CSV filename directly and point to the Pokémon Icons folder (URL-encoded)
                    //     const iconsFolder = encodeURIComponent('Pokémon Icons');
                    //     img.src = '/' + iconsFolder + '/' + encodeURIComponent(pokemon.Sprite);
                    //     img.onerror = function() {{ this.style.display = 'none'; }};
                    //     item.appendChild(img);
                    // }}
                    
                    // Create text span
                    const textSpan = document.createElement('span');
                    textSpan.className = 'dropdown-item-text';
                    textSpan.textContent = pokemon.name;
                    item.appendChild(textSpan);
                    
                    item.onclick = () => selectPokemon(pokemon, select, dropdown);
                    dropdown.appendChild(item);
                }});
            }}
            
            dropdown.classList.add('active');
        }}
        
        // Select a Pokémon
        function selectPokemon(pokemon,select,dropdown) {{
            document.getElementById(select).value = pokemon.name;
            document.getElementById(dropdown).classList.remove('active');
            
            // Determine which Pokemon to update (1 or 2)
            const pokemonSide = select === 'select1' ? 1 : 2;
            
            // Update the display AND the comparison data
            updatePokemonDisplay(pokemon.name, pokemonSide);
            updateButton();
        }}


        //iterate the pokemon data and add name and number to dropdowns
        function populateDropdown(selectId) {
            const select = document.getElementById(selectId);

            pokemonData.forEach(pokemon => {

                const option = document.createElement('option');
                option.value = pokemon.name;
                option.textContent = `${pokemon.name} (#${pokemon.number})`;
                select.appendChild(option);

            });
        }

        function updatePokemonDisplay(name, side) {
            const pokemon = pokemonData.find(p => p.name === name);
            if (!pokemon) return;

            const sideNum = side === 1 ? 'pokemon1' : 'pokemon2';
            const imgContainer = document.querySelector(`#${sideNum} .pokemon-image`);
            const img = imgContainer.querySelector('img');
            const nameDiv = document.querySelector(`#${sideNum} .pokemon-name`);
            
            img.src = `https://raw.githubusercontent.com/PokeAPI/sprites/master/sprites/pokemon/${pokemon.number}.png`;
    
            img.style.display = 'block';
            nameDiv.textContent = pokemon.name;
            
            if (side === 1) {
                currentPokemon1 = pokemon;
            } else {
                currentPokemon2 = pokemon;
            }
        }

        function updateButton() {
            const select1 = document.getElementById('select1').value;
            const select2 = document.getElementById('select2').value;
            
            
            if (!select1 || !select2) {
                 // Clear chart if invalid
                document.getElementById('visualization').innerHTML = '';
                showError('Please select two different Pokémon.');
            } else {
                hideError();
                createComparisonChart();
            }
        }

        //event listeners
        // chnage in pokemon1
        document.getElementById('select1').addEventListener('change', (e) => {
            updatePokemonDisplay(e.target.value, 1);
            updateButton();
        });

        //change in pokemon2
        document.getElementById('select2').addEventListener('change', (e) => {
            updatePokemonDisplay(e.target.value, 2);
            updateButton();
        });

        //change in stat type selection
        document.getElementById('select-stat-type').addEventListener('change', (e) => {
            const statType = e.target.value;
            if (statType) {
                createTypeStatChart(statType);
            }
        });

        //check changes to either search input to update dropdown
        document.getElementById('select1').addEventListener('input', () => updateDropdown('select1'));
        document.getElementById('select2').addEventListener('input', () => updateDropdown('select2'));


        document.getElementById('select1').addEventListener('keydown', function(e) {{
            if (e.key === 'Enter') {{
                const dropdown = document.getElementById('dropdown1');
                const items = dropdown.querySelectorAll('.dropdown-item');
                if (items.length > 0) {{
                    items[0].click();
                }}
                document.getElementById('dropdown1').classList.remove('active');
            }}
        }});

        document.getElementById('select2').addEventListener('keydown', function(e) {{
            if (e.key === 'Enter') {{
                const dropdown = document.getElementById('dropdown2');
                const items = dropdown.querySelectorAll('.dropdown-item');
                if (items.length > 0) {{
                    items[0].click();
                }}
                document.getElementById('dropdown2').classList.remove('active');
            }}
        }});
        
        document.addEventListener('click', function(e) {{
            if (!e.target.closest('.search-container')) {{
                document.getElementById('dropdown1').classList.remove('active');
                document.getElementById('dropdown2').classList.remove('active');
            }}
        }});

        function showError(message) {
            const errorDiv = document.getElementById('error');
            errorDiv.textContent = message;
            errorDiv.style.display = 'block';
        }

        function hideError() {
            document.getElementById('error').style.display = 'none';
        }

        function createComparisonChart() {
            const stats = ['HP', 'Attack', 'Defense', 'Sp.Attack', 'Sp.Defense', 'Speed'];
            const p1Stats = [currentPokemon1.hp, currentPokemon1.attack, currentPokemon1.defense,
                           currentPokemon1.spAttack, currentPokemon1.spDefense, currentPokemon1.speed];
            const p2Stats = [currentPokemon2.hp, currentPokemon2.attack, currentPokemon2.defense,
                           currentPokemon2.spAttack, currentPokemon2.spDefense, currentPokemon2.speed];

            const data = [];
            
            //iterate stats and push respective stat for each pokemon into data array
            stats.forEach((stat, i) => {
                data.push({
                    stat: stat,
                    value: p1Stats[i],
                    pokemon: currentPokemon1.name,
                    side: 'pokemon1'
                });

                data.push({
                    stat: stat,
                    value: p2Stats[i],
                    pokemon: currentPokemon2.name,
                    side: 'pokemon2'
                });
            });

            const spec = {
                $schema: 'https://vega.github.io/schema/vega-lite/v5.json',
                data: { values: data },
                width: 700,
                height: 400,
                mark: { type: 'bar' },
                encoding: {
                    x: {
                        field: 'stat',
                        type: 'nominal',
                        sort: stats,
                        axis: { title: null, labelAngle: 0 }
                    },
                    y: {
                        field: 'value',
                        type: 'quantitative',
                        axis: { title: 'Stat Value' },
                        scale: { domain: [0, 255] }
                    },
                    color: {
                        field: 'side',
                        type: 'nominal',
                        scale: { 
                            domain: ['pokemon1', 'pokemon2'],
                            range: ['#2563eb', '#dc2626']
                        },
                        legend: {
                            title: 'Pokemon',
                            labelExpr: `datum.label === 'pokemon1' ? '${currentPokemon1.name}' : '${currentPokemon2.name}'`
                        }
                    },
                    xOffset: { field: 'side',
                        scale: { 
                            domain: ['pokemon1', 'pokemon2']  // Ensures left/right order
                        }
                    },
                    tooltip: [
                        { field: 'pokemon', type: 'nominal', title: 'Pokemon' },
                        { field: 'stat', type: 'nominal', title: 'Stat' },
                        { field: 'value', type: 'quantitative', title: 'Value' }
                        
                    ]
                },
                config: {
                    view: { stroke: null },
                    axis: { domainColor: '#ccc', gridColor: '#eee' }
                }
            };

            vegaEmbed('#visualization', spec, { actions: false })
                .catch(error => showError('Error creating chart: ' + error.message));
        }

        function createTypeStatChart(statType) {

            const data = Object.keys(typeStats).map(type => ({
                type: type,
                average: Math.round(typeStats[type][statType] / typeStats[type].count)
            }));

            const typeColors = {
                'Normal': 'grey',
                'Fire': 'red',
                'Water': 'blue',
                'Electric': 'yellow',
                'Grass': 'green',
                'Ice': '#98D8D8',
                'Fighting': '#C03028',
                'Poison': '#A040A0',
                'Ground': '#8B4513',
                'Flying': '#A890F0',
                'Psychic': '#F85888',
                'Bug': '#A8B820',
                'Rock': '#B8A038',
                'Ghost': '#705898',
                'Dragon': 'orange',
                'Dark': 'black',
                'Steel': '#B8B8D0',
                'Fairy': '#EE99AC'
            };


            const spec2 = {
                $schema: 'https://vega.github.io/schema/vega-lite/v5.json',
                data: { values: data },
                width: 800,
                height: 400,
                mark: 'bar',
                encoding: {
                    x: { field: 'type', type: 'nominal', axis: { title: 'Pokemon Type' } },
                    y: { field: 'average', type: 'quantitative', axis: { title: `Average ${statType}` } },
                    color: { 
                        field: 'type', 
                        type: 'nominal',
                        scale: {
                            domain: Object.keys(typeColors),
                            range: Object.values(typeColors)
                        }
                    },
                    tooltip: [
                        { field: 'type', type: 'nominal', title: 'Type' },
                        { field: 'average', type: 'quantitative', title: `Average ${statType}` }
                    ]
                },
                config: {
                    view: { stroke: null },
                    axis: { domainColor: '#ccc', gridColor: '#eee' }
                }
            };

            vegaEmbed('#visualization2', spec2, { actions: false })
                .catch(error => showError('Error creating chart: ' + error.message));
        }

        // Scatter: offense stats positive x, defense stats negative x
        function createScatterChart() {
            const stats = [
                { key: 'attack', label: 'Attack', sign: 1 },
                { key: 'defense', label: 'Defense', sign: -1 },
                { key: 'spAttack', label: 'Sp.Attack', sign: 1 },
                { key: 'spDefense', label: 'Sp.Defense', sign: -1 },
                { key: 'speed', label: 'Speed', sign: 1 }
            ];

            const scatterData = [];
            let maxVal = 0;
            pokemonData.forEach(p => {
                stats.forEach(s => {
                    const raw = p[s.key] || 0;
                    const signed = raw * s.sign;
                    scatterData.push({
                        pokemon: p.name,
                        type1: p.type1,
                        stat: s.label,
                        value: raw,
                        x: signed
                    });
                    if (raw > maxVal) maxVal = raw;
                });
            });

            const domainMax = Math.max(255, Math.ceil(maxVal / 10) * 10);

            const spec3 = {
                $schema: 'https://vega.github.io/schema/vega-lite/v5.json',
                data: { values: scatterData },
                width: 900,
                height: 360,
                mark: { type: 'point', filled: true, size: 60 },
                encoding: {
                    x: {
                        field: 'x',
                        type: 'quantitative',
                        axis: { title: 'Stat value (defense shown as negative)' },
                        scale: { domain: [-domainMax, domainMax] }
                    },
                    y: {
                        field: 'stat',
                        type: 'nominal',
                        axis: { title: null }
                    },
                    color: {
                        field: 'type1',
                        type: 'nominal',
                        legend: { title: 'Primary Type' }
                    },
                    tooltip: [
                        { field: 'pokemon', type: 'nominal', title: 'Pokemon' },
                        { field: 'type1', type: 'nominal', title: 'Type' },
                        { field: 'stat', type: 'nominal', title: 'Stat' },
                        { field: 'value', type: 'quantitative', title: 'Value' }
                    ],
                    opacity: { value: 0.85 }
                },
                config: {
                    view: { stroke: null },
                    axis: { domainColor: '#ccc', gridColor: '#eee' }
                }
            };

            vegaEmbed('#visualization3', spec3, { actions: false })
                .catch(err => showError('Error creating scatter: ' + err.message));
        }

        // Handle anchor navigation on page load
        function handleAnchorNavigation() {
            const hash = window.location.hash;
            if (hash) {
                const targetElement = document.querySelector(hash);
                if (targetElement) {
                    // Small delay to ensure page is fully rendered
                    setTimeout(() => {
                        targetElement.scrollIntoView({ behavior: 'smooth' });
                    }, 100);
                }
            }
        }

        // Run on page load
        window.addEventListener('load', handleAnchorNavigation);

        // Also run when hash changes (if user clicks anchor while already on page)
        window.addEventListener('hashchange', handleAnchorNavigation);

    </script>
</body>
</html>
